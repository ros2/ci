FROM centos:8

# Add some repos
RUN dnf install epel-release epel-release 'dnf-command(config-manager)' --refresh -y && \
    dnf config-manager --set-enabled powertools && \
    rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-*

# Install foundation packages
RUN dnf install \
    cmake \
    gcc-c++ \
    git \
    glibc-langpack-en \
    make \
    matchbox-window-manager \
    mesa-dri-drivers \
    net-tools \
    patch \
    python3-bloom \
    python3-colcon-common-extensions \
    python3-devel \
    python3-pip \
    python3-rosdep \
    python3-vcstool \
    python3-virtualenv \
    sudo \
    vim \
    wget \
    xorg-x11-server-Xvfb \
    --refresh -y

# Try to update to any ROS packages currently in testing
RUN dnf update \
    python3-bloom* \
    python3-catkin* \
    python3-colcon* \
    python3-ros* \
    python3-vcstool \
    --enablerepo=epel-testing --skip-broken --refresh -y

# Initialize rosdep
RUN rosdep init && rosdep update

# Install some stuff via Pip which we don't have available in EPEL
RUN python3 -m pip install mypy==0.761 pydocstyle

# Install a newer version of pytest
RUN python3 -m pip install -U pytest pytest-rerunfailures

# These dependencies were generated by invoking rosdep on the latest version of the target workspace:
RUN dnf install \
    CUnit-devel \
    acl \
    assimp-devel \
    bison \
    bullet-devel \
    clang \
    clang-tools-extra \
    console-bridge-devel \
    cppcheck \
    cppunit-devel \
    eigen3-devel \
    freetype-devel \
    gmock-devel \
    google-benchmark-devel \
    gtest-devel \
    libX11-devel \
    libXaw-devel \
    libXext-devel \
    libXrandr-devel \
    libacl-devel \
    libatomic \
    libcurl-devel \
    libsq3-devel \
    libyaml-devel \
    libzstd-devel \
    log4cxx-devel \
    mesa-libGL-devel \
    mesa-libGLU-devel \
    opencv-devel \
    openssl-devel \
    python3-cairo \
    python3-cryptography \
    python3-flake8 \
    python3-ifcfg \
    python3-importlib-metadata \
    python3-importlib-resources \
    python3-lark-parser \
    python3-lxml \
    python3-matplotlib \
    python3-mock \
    python3-netifaces \
    python3-nose \
    python3-numpy \
    python3-packaging \
    python3-pillow \
    python3-psutil \
    python3-pycodestyle \
    python3-pydot \
    python3-pyflakes \
    python3-pygraphviz \
    python3-pytest-mock \
    python3-qt5-devel \
    qt5-qtbase \
    qt5-qtbase-devel \
    qt5-qtbase-gui \
    redhat-rpm-config \
    spdlog-devel \
    tinyxml-devel \
    tinyxml2-devel \
    uncrustify \
    --refresh -y

# Install dependencies of Connext and its installer
RUN dnf install \
    libnsl2-devel \
    python3-pexpect \
    --refresh -y

# Get and install the RTI web binaries.
RUN cd /tmp && curl --silent https://s3.amazonaws.com/RTI/Bundles/5.3.1/Evaluation/rti_connext_dds_secure-5.3.1-eval-x64Linux3gcc5.4.0.tar.gz | tar -xz
RUN cd /tmp && tar -xvf /tmp/openssl-1.0.2n-target-x64Linux3gcc5.4.0.tar.gz
ADD rti_web_binaries_install_script.py /tmp/rti_web_binaries_install_script.py

# Add the RTI license file.
ADD rticonnextdds-license/rti_license.dat /tmp/rti_license.dat

# automatic invalidation once every day.
RUN echo "@today_str"
RUN dnf update --refresh -y

ENV CMAKE_PREFIX_PATH=/usr
ENV DISPLAY=:99
ENV LANG=en_US.UTF-8

# Create a user to own the build output.
RUN useradd -u 1234 -m rosbuild
RUN sudo -H -u rosbuild -- git config --global user.email "jenkins@ci.ros2.org"
RUN sudo -H -u rosbuild -- git config --global user.name "Jenkins ROS 2"
RUN echo 'rosbuild ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers
WORKDIR "@workdir"

# RHEL 8 doesn't have Asio yet, but Fast-DDS can bundle it
ADD fastrtps-bundle-asio.meta /home/rosbuild/.colcon/metadata/fastrtps.meta
# The version of Eigen in RHEL-8 (3.3.4) has a bug in it that causes
# many warnings from "-Wint-in-bool-context".  Suppress it here.
ADD tf2_eigen-disable-compiler-warning.meta /home/rosbuild/.colcon/metadata/tf2_eigen.meta
RUN chown rosbuild: /home/rosbuild/.colcon -R

# Add an entry point which changes rosbuild's UID from 1234 to the UID of the invoking user.
# This means that the generated files will have the same ownership as the host OS user.
ADD entry_point.sh /entry_point.sh
RUN chmod 755 /entry_point.sh

ENTRYPOINT ["/entry_point.sh"]

CMD ["matchbox-window-manager > /dev/null 2>&1 & python3 -u run_ros2_batch.py $CI_ARGS"]
