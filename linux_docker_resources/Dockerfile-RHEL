FROM almalinux:8
ARG ROS_DISTRO=rolling
ARG EL_RELEASE=8

# Pin $releasever
RUN sed -i "s/\$releasever/${EL_RELEASE}/g" /etc/yum.repos.d/*.repo

# Add some repos
RUN dnf install epel-release 'dnf-command(config-manager)' --refresh -y && \
    dnf config-manager --set-enabled $(if test ${EL_RELEASE/.*/} = 8; then echo powertools; else echo crb; fi) && \
    rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-*

# Install foundation packages
RUN dnf install \
    cmake \
    gcc-c++ \
    git \
    glibc-langpack-en \
    make \
    $(if test ${EL_RELEASE/.*/} != 10; then echo matchbox-window-manager; fi) \
    mesa-dri-drivers \
    net-tools \
    patch \
    python3-colcon-bash \
    python3-colcon-cmake \
    python3-colcon-core \
    python3-colcon-defaults \
    python3-colcon-library-path \
    python3-colcon-metadata \
    python3-colcon-mixin \
    python3-colcon-output \
    python3-colcon-package-information \
    python3-colcon-package-selection \
    python3-colcon-parallel-executor \
    python3-colcon-pkg-config \
    python3-colcon-powershell \
    python3-colcon-python-setup-py \
    python3-colcon-recursive-crawl \
    python3-colcon-ros \
    $(if test ${EL_RELEASE/.*/} != 8; then echo python3-colcon-ros-domain-id-coordinator; fi) \
    python3-colcon-test-result \
    python3-colcon-zsh \
    python3-devel \
    python3-jsonschema \
    python3-pip \
    python3-rosdep \
    python3-vcstool \
    python3-virtualenv \
    sudo \
    vim \
    wget \
    $(if test ${EL_RELEASE/.*/} = 10; then echo xwayland-run; else echo xorg-x11-server-Xvfb; fi) \
    --refresh -y

# Try to update to any ROS packages currently in testing
RUN dnf update \
    python3-bloom* \
    python3-catkin* \
    python3-colcon* \
    python3-ros* \
    python3-vcstool \
    --enablerepo=epel-testing --skip-broken --refresh -y

# Initialize rosdep
RUN rosdep init && rosdep update

# These dependencies were generated by invoking rosdep on the latest version of the target workspace:
# rosdep install --from-paths src --ignore-src --simulate --reinstall --skip-keys ...
RUN dnf install \
    CUnit-devel \
    acl \
    $(if test ${EL_RELEASE/.*/} != 8; then echo asio-devel; fi) \
    assimp-devel \
    bison \
    boost-devel \
    bullet-devel \
    $(if test ${ROS_DISTRO} != humble -a ${ROS_DISTRO} != jazzy; then echo cargo; fi) \
    clang \
    clang-tools-extra \
    cmake3 \
    console-bridge-devel \
    cppcheck \
    cppunit-devel \
    $(if test ${EL_RELEASE/.*/} = 8; then echo curl; else echo curl-minimal; fi) \
    doxygen \
    eigen3-devel \
    file \
    freetype \
    freetype-devel \
    git \
    gmock-devel \
    google-benchmark-devel \
    graphviz \
    gtest-devel \
    libX11-devel \
    libXaw-devel \
    libXext-devel \
    libXrandr-devel \
    libacl-devel \
    libatomic \
    libcurl-devel \
    libsq3-devel \
    libxml2 \
    libyaml-devel \
    libzstd-devel \
    $(if test ${EL_RELEASE/.*/} != 8; then echo lttng-tools; fi) \
    $(if test ${EL_RELEASE/.*/} != 8; then echo lttng-tools-devel; fi) \
    $(if test ${EL_RELEASE/.*/} != 8; then echo lttng-ust-devel; fi) \
    lz4-devel \
    mesa-libGL-devel \
    mesa-libGLU-devel \
    $(if test ${ROS_DISTRO} != humble -a ${ROS_DISTRO} != jazzy; then echo json-devel; fi) \
    opencv-devel \
    openssl \
    openssl-devel \
    orocos-kdl-devel \
    pkgconfig \
    procps-ng \
    $(if test ${EL_RELEASE/.*/} != 8; then echo pybind11-devel; fi) \
    python3-PyYAML \
    python3-argcomplete \
    $(if test ${EL_RELEASE/.*/} != 8; then echo python3-babeltrace; fi) \
    python3-cairo \
    python3-catkin_pkg \
    python3-cryptography \
    python3-devel \
    python3-empy \
    $(if test ${EL_RELEASE/.*/} != 8; then echo python3-fastjsonschema; fi) \
    python3-flake8 \
    $(if test ${EL_RELEASE/.*/} != 8; then echo python3-flake8-blind-except; fi) \
    $(if test ${EL_RELEASE/.*/} != 8; then echo python3-flake8-builtins; fi) \
    $(if test ${EL_RELEASE/.*/} != 8; then echo python3-flake8-class-newline; fi) \
    $(if test ${EL_RELEASE/.*/} != 8; then echo python3-flake8-comprehensions; fi) \
    $(if test ${EL_RELEASE/.*/} != 8; then echo python3-flake8-deprecated; fi) \
    $(if test ${ROS_DISTRO} = humble -o ${ROS_DISTRO} = jazzy -o ${ROS_DISTRO} = kilted; then echo python3-flake8-docstrings; fi) \
    $(if test ${EL_RELEASE/.*/} != 8; then echo python3-flake8-import-order; fi) \
    $(if test ${EL_RELEASE/.*/} != 8; then echo python3-flake8-quotes; fi) \
    python3-importlib-metadata \
    $(if test ${EL_RELEASE/.*/} = 8; then echo python3-importlib-resources; fi) \
    python3-lark-parser \
    $(if test ${EL_RELEASE/.*/} != 8; then echo python3-lttng; fi) \
    python3-lxml \
    python3-matplotlib \
    $(if test ${EL_RELEASE/.*/} = 8; then echo python3-mock; fi) \
    $(if test ${EL_RELEASE/.*/} != 8; then echo python3-mypy; fi) \
    $(if test ${ROS_DISTRO} = humble; then echo python3-netifaces; fi) \
    $(if test ${EL_RELEASE/.*/} = 8; then echo python3-nose; fi) \
    python3-numpy \
    python3-osrf-pycommon \
    python3-packaging \
    python3-pillow \
    python3-psutil \
    python3-pycodestyle \
    $(if test ${EL_RELEASE/.*/} != 8; then echo python3-pydantic; fi) \
    $(if test ${EL_RELEASE/.*/} != 10; then echo python3-pydocstyle; fi) \
    python3-pydot \
    python3-pyflakes \
    python3-pygraphviz \
    python3-pykdl \
    python3-pytest \
    python3-pytest-cov \
    python3-pytest-mock \
    python3-pytest-repeat \
    python3-pytest-rerunfailures \
    python3-pytest-runner \
    python3-pytest-timeout \
    python3-qt5-devel \
    python3-rosdistro \
    python3-setuptools \
    $(if test ${EL_RELEASE/.*/} != 10; then echo python3-sip-devel; fi) \
    $(if test ${EL_RELEASE/.*/} != 8; then echo python3-types-pyyaml; fi) \
    qt5-qtbase \
    qt5-qtbase-devel \
    qt5-qtbase-gui \
    redhat-rpm-config \
    spdlog-devel \
    sqlite-devel \
    tango-icon-theme \
    $(if test \( ${ROS_DISTRO} = humble \); then echo tinyxml-devel; fi) \
    tinyxml2-devel \
    uncrustify \
    yaml-cpp-devel \
    $(if test ${EL_RELEASE/.*/} != 10; then echo yamllint; fi) \
    --refresh -y

# Install dependencies of Connext and its installer
RUN dnf install \
    libnsl2-devel \
    python3-pexpect \
    --refresh -y

# Get and install the RTI Connext web binaries.
# RTI Connext web binaries installation is only supported on x86_64.
COPY rticonnextdds-src/ /tmp/rticonnextdds-src

# Join the correct Connext version files based on the value of ROS_DISTRO.
RUN if test ${ROS_DISTRO} = jazzy -o ${ROS_DISTRO} = humble; then \
  for splitpkg in \
    /tmp/rticonnextdds-src/rti_connext_dds-6.0.1-pro-host-x64Linux.run \
    /tmp/rticonnextdds-src/rti_connext_dds-6.0.1.25-pro-host-x64Linux.rtipkg \
    /tmp/rticonnextdds-src/rti_connext_dds-6.0.1.25-pro-target-x64Linux4gcc7.3.0.rtipkg; do \
    cat $(echo ${splitpkg}.0?? | sort) > $splitpkg; \
  done; \
    else \
  for splitpkg in \
    /tmp/rticonnextdds-src/rti_connext_dds-7.3.0-pro-host-x64Linux.run \
    /tmp/rticonnextdds-src/rti_connext_dds-7.3.0-pro-target-x64Linux4gcc7.3.0.rtipkg; do \
    cat $(echo ${splitpkg}.0?? | sort) > $splitpkg; \
  done; \
    fi

# Make the RTI Connext installation script executable. For any version of Connext.
RUN chmod 755 /tmp/rticonnextdds-src/rti_connext_dds-*-pro-host-x64Linux.run

ADD rti_web_binaries_install_script.py /tmp/rti_web_binaries_install_script.py

# Add the RTI license file.
ADD rticonnextdds-license/rti_license.dat /tmp/rti_license.dat

# Install newer versions of some pip packages for RHEL-8
RUN if test ${EL_RELEASE/.*/} = 8; then \
  echo -e "EmPy<4\ncryptography<=3.0\nflake8<5.0.0\nflake8-blind-except==0.1.1\nflake8-import-order==0.18.2\nlark==1.1.1\nmypy==0.942\npycodestyle==2.5.0\npyparsing==2.4.7\npytest==6.2.5\npytest-timeout==2.1.0\nsetuptools==59.6.0" > constraints.txt && \
  python3 -m pip install -c constraints.txt -U colcon-ros-domain-id-coordinator flake8-blind-except==0.1.1 flake8-builtins flake8-class-newline flake8-comprehensions flake8-deprecated flake8-import-order flake8-quotes mypy pycodestyle pytest pytest-rerunfailures==10.2 && \
  rm -f constraints.txt ; \
elif test ${EL_RELEASE/.*/} = 10; then \
  # Pydocstyle is deprecated and has been removed from RHEL 10
  python3 -m pip install -U pydocstyle ; \
fi

# automatic invalidation once every day.
RUN echo "@today_str"
RUN dnf update --refresh -y

ENV CMAKE_PREFIX_PATH=/usr
ENV DISPLAY=:99
ENV LANG=en_US.UTF-8

# Create a user to own the build output.
RUN useradd -u 1234 -m rosbuild
RUN sudo -H -u rosbuild -- git config --global user.email "jenkins@ci.ros2.org"
RUN sudo -H -u rosbuild -- git config --global user.name "Jenkins ROS 2"
RUN echo 'rosbuild ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

# RHEL 8 doesn't have Asio yet, but Fast-DDS can bundle it
ADD fastrtps-bundle-asio.meta /home/rosbuild/.colcon/metadata-disabled/fastrtps.meta
# The version of Eigen in RHEL-8 (3.3.4) has a bug in it that causes
# many warnings from "-Wint-in-bool-context".  Suppress it here.
ADD tf2_eigen-disable-compiler-warning.meta /home/rosbuild/.colcon/metadata-disabled/tf2_eigen.meta
RUN if test ${EL_RELEASE/.*/} = 8; then mkdir -p /home/rosbuild/.colcon/metadata && mv /home/rosbuild/.colcon/metadata-disabled/{fastrtps,tf2_eigen}.meta /home/rosbuild/.colcon/metadata/; fi
RUN chown rosbuild: /home/rosbuild/.colcon -R

# Add an entry point which changes rosbuild's UID from 1234 to the UID of the invoking user.
# This means that the generated files will have the same ownership as the host OS user.
COPY entry_point.sh /entry_point.sh
RUN chmod 755 /entry_point.sh

ENTRYPOINT ["/entry_point.sh"]

CMD ["if test ${EL_RELEASE/.*/} != 10; then matchbox-window-manager > /dev/null 2>&1 & fi; python3 -u run_ros2_batch.py $CI_ARGS"]
