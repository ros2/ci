FROM centos:7

# Update existing packages
RUN yum -y update

# Add some repos
RUN yum -y install epel-release centos-release-scl-rh
RUN rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-*

# Add some COPRs
RUN yum -y install yum-plugin-copr
RUN yum -y copr enable cottsay/colcon

# Install foundation packages
RUN yum install \
  @buildsys-build \
  asio-devel \
  ccache \
  cmake \
  cmake3 \
  devtoolset-8 \
  devtoolset-8-liblsan-devel \
  git \
  matchbox-window-manager \
  net-tools \
  python36-colcon-common-extensions \
  python36-devel \
  python36-docutils \
  python36-lark-parser \
  python36-numpy \
  python36-pip \
  python36-pytest \
  python36-pytest-repeat \
  python36-setuptools \
  python36-vcstool \
  python36-virtualenv \
  python-rosdep \
  sudo \
  tinyxml2-devel \
  wget \
  xorg-x11-server-Xvfb \
  -y

# Install some stuff via Pip which we don't have available in EPEL
RUN pip3.6 install flake8 lxml matplotlib pep8 pydocstyle pydot pyflakes pytest-rerunfailures

# Some support vars for building
ENV CMAKE_COMMAND /usr/bin/cmake3
ENV ROS_PYTHON_VERSION 3
ENV CFLAGS -I/usr/lib64/python3.6/site-packages/numpy/core/include
ENV CXXFLAGS -Wno-error=int-in-bool-context -I/usr/lib64/python3.6/site-packages/numpy/core/include
ENV LANG en_US.UTF-8

# Set up rosdep
RUN rosdep init

# automatic invalidation once every day.
RUN echo "@today_str"
RUN yum -y update

# These dependencies were generated by invoking rosdep on the latest version of the target workspace:
RUN yum install \
  assimp-devel \
  clang \
  console-bridge-devel \
  cppcheck \
  cppunit-devel \
  eigen3-devel \
  freetype-devel \
  libX11-devel \
  libXaw-devel \
  libXrandr-devel \
  libcurl-devel \
  libyaml-devel \
  log4cxx-devel \
  mesa-libGL-devel \
  mesa-libGLU-devel \
  minizip-devel \
  opencv-devel \
  openssl \
  poco-devel \
  python2-mock \
  python36-mock \
  python36-psutil \
  python36-pygraphviz \
  qt5-qtbase \
  qt5-qtbase-devel \
  qt5-qtbase-gui \
  tinyxml-devel \
  uncrustify \
  zziplib-devel \
  -y

# Create a user to own the build output.
RUN useradd -u 1234 -m rosbuild
RUN sudo -H -u rosbuild -- git config --global user.email "jenkins@ci.ros2.org"
RUN sudo -H -u rosbuild -- git config --global user.name "Jenkins ROS 2"
RUN echo 'rosbuild ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers
WORKDIR "@workdir"

# Add an entry point which changes rosbuild's UID from 1234 to the UID of the invoking user.
# This means that the generated files will have the same ownership as the host OS user.
ADD entry_point.sh /entry_point.sh
RUN chmod 755 /entry_point.sh

ENTRYPOINT ["/entry_point.sh"]

CMD ["matchbox-window-manager > /dev/null 2>&1 & scl enable devtoolset-8 -- python36 -u run_ros2_batch.py $CI_ARGS"]
