FROM centos:7

# Update existing packages
RUN yum -y update

# Add some repos
RUN yum -y install epel-release centos-release-scl-rh
RUN rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-*

# Add some COPRs
RUN yum -y install yum-plugin-copr
RUN yum -y copr enable cottsay/devtoolset-8-make-nonblocking

# Install foundation packages
RUN yum install \
  @buildsys-build \
  asio-devel \
  bullet-devel \
  ccache \
  cmake \
  cmake3 \
  dbus \
  devtoolset-8 \
  devtoolset-8-liblsan-devel \
  devtoolset-8-make-nonblocking \
  git \
  matchbox-window-manager \
  mesa-dri-drivers \
  net-tools \
  python36-colcon-common-extensions \
  python36-cryptography \
  python36-devel \
  python36-docutils \
  python36-pip \
  python36-pycodestyle \
  python36-pytest-repeat \
  python36-snowballstemmer \
  python36-vcstool \
  python36-virtualenv \
  python-rosdep \
  sudo \
  systemd \
  tinyxml2-devel \
  wget \
  xorg-x11-server-Xvfb \
  -y

# Try to update to any ROS packages in testing
RUN sudo yum update \
  python{2,3[46]}-catkin* \
  python{2,3[46]}-ros* \
  python3[46]-colcon* \
  python3[46]-vcstool \
  --enablerepo=epel-testing \
  --skip-broken \
  -y

# Initialize the D-bus machine ID
RUN dbus-uuidgen >/etc/machine-id

# Install some stuff via Pip which we don't have available in EPEL
RUN pip3.6 install flake8 matplotlib pep8 pydocstyle pydot pytest-mock pytest-rerunfailures

# Some support vars for building
ENV CMAKE_COMMAND /usr/bin/cmake3
ENV ROS_PYTHON_VERSION 3
ENV CFLAGS -I/usr/lib64/python3.6/site-packages/numpy/core/include
ENV CXXFLAGS -Wno-error=int-in-bool-context -I/usr/lib64/python3.6/site-packages/numpy/core/include
ENV LANG en_US.UTF-8

# Set up rosdep
RUN rosdep init

# automatic invalidation once every day.
RUN echo "@today_str"
RUN yum -y update

# These dependencies were generated by invoking rosdep on the latest version of the target workspace:
RUN yum install \
  assimp-devel \
  clang \
  console-bridge-devel \
  cppcheck \
  cppunit-devel \
  CUnit-devel \
  curl \
  eigen3-devel \
  freetype \
  freetype-devel \
  libcurl-devel \
  libsq3-devel \
  libX11-devel \
  libXaw-devel \
  libxml2 \
  libXrandr-devel \
  libyaml-devel \
  log4cxx-devel \
  mesa-libGL-devel \
  mesa-libGLU-devel \
  opencv-devel \
  openssl \
  pcre-devel \
  pkgconfig \
  poco-devel \
  python36-catkin_pkg \
  python36-empy \
  python36-ifcfg \
  python36-lark-parser \
  python36-lxml \
  python36-mock \
  python36-netifaces \
  python36-numpy \
  python36-psutil \
  python36-pyflakes \
  python36-pygraphviz \
  python36-pytest \
  python36-PyYAML \
  python36-qt5-devel \
  python36-setuptools \
  qt5-qtbase \
  qt5-qtbase-devel \
  qt5-qtbase-gui \
  spdlog-devel \
  tinyxml2-devel \
  tinyxml-devel \
  uncrustify \
  zlib-devel \
  -y

# Create a user to own the build output.
RUN useradd -u 1234 -m rosbuild
RUN sudo -H -u rosbuild -- git config --global user.email "jenkins@ci.ros2.org"
RUN sudo -H -u rosbuild -- git config --global user.name "Jenkins ROS 2"
RUN echo 'rosbuild ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers
WORKDIR "@workdir"

# Add an entry point which changes rosbuild's UID from 1234 to the UID of the invoking user.
# This means that the generated files will have the same ownership as the host OS user.
ADD entry_point.sh /entry_point.sh
RUN chmod 755 /entry_point.sh

ENTRYPOINT ["/entry_point.sh"]

CMD ["matchbox-window-manager > /dev/null 2>&1 & . /opt/rh/devtoolset-8/enable && python3.6 -u run_ros2_batch.py $CI_ARGS"]
